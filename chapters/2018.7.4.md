# Android Pä¸­æ–‡æœ¬çš„æ–°åŠŸèƒ½

åŸæ ‡é¢˜ï¼šWhat's new for text in Android P  
é“¾æ¥ï¼š[https://android-developers.googleblog.com/2018/07/whats-new-for-text-in-android-p.html](https://android-developers.googleblog.com/2018/07/whats-new-for-text-in-android-p.html)  
ä½œè€…ï¼š[Florina Muntenescu](https://twitter.com/FMuntenescu) (å¼€å‘è€…å€¡å¯¼è€…)å’Œ[Siyamed Sinir](https://twitter.com/siyamed) (Androidæ–‡æœ¬æŠ€æœ¯ä¸»ç®¡)  
ç¿»è¯‘ï¼š[arjinmc](https://github.com/arjinmc)  

åœ¨â€œ[Android P Betaä¸­çš„æ–°åŠŸèƒ½](https://android-developers.googleblog.com/2018/05/whats-new-in-android-p-beta.html)â€ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†Androidä¸­çš„ä¸¤ä¸ªæ–°æ–‡æœ¬åŠŸèƒ½ã€‚ç°åœ¨[Android P Beta 2å’Œæœ€ç»ˆçš„API](https://android-developers.googleblog.com/2018/06/android-p-beta-2-and-final-apis.html)éƒ½åœ¨è¿™é‡Œï¼Œç°åœ¨æ˜¯æ—¶å€™æ·±å…¥äº†è§£æ–‡æœ¬çš„æ–°å†…å®¹ã€‚æˆ‘ä»¬çŸ¥é“[TextView](https://developer.android.com/reference/android/widget/TextView)æ˜¯Androidè§†å›¾ç³»ç»Ÿä¸­æœ€é‡è¦çš„ç»„ä»¶ä¹‹ä¸€ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ç»§ç»­æŠ•èµ„äºé¢å‘å¼€å‘è€…å’Œé¢å‘ç”¨æˆ·çš„åŠŸèƒ½ä»¥åŠAPIæ”¹è¿›çš„åŸå› ã€‚

## PrecomputedText

æ˜¾ç¤ºæ–‡æœ¬å¯èƒ½å¾ˆå¤æ‚ï¼ŒåŒ…å«å¤šç§å­—ä½“ï¼Œè¡Œé—´è·ï¼Œå­—æ¯é—´è·ï¼Œæ–‡æœ¬æ–¹å‘ï¼Œæ¢è¡Œç¬¦ï¼Œè¿å­—ç¬¦ç­‰åŠŸèƒ½ã€‚TextViewå¿…é¡»åšå¾ˆå¤šå·¥ä½œæ¥æµ‹é‡å’Œå¸ƒç½®ç»™å®šçš„æ–‡æœ¬ï¼šè¯»å–å­—ä½“æ–‡ä»¶ï¼ŒæŸ¥æ‰¾å­—å½¢ï¼Œç¡®å®šå½¢çŠ¶ï¼Œæµ‹é‡è¾¹ç•Œæ¡†ä»¥åŠåœ¨å†…éƒ¨å­—ç¼“å­˜ä¸­ç¼“å­˜å•è¯ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ‰€æœ‰è¿™äº›å·¥ä½œéƒ½å‘ç”Ÿåœ¨UIçº¿ç¨‹ä¸Šï¼Œå®ƒå¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„åº”ç”¨ç¨‹åºä¸¢å¸§ã€‚

æˆ‘ä»¬å‘ç°æµ‹é‡æ–‡æœ¬å¯èƒ½å ç”¨è®¾ç½®æ–‡æœ¬æ‰€éœ€æ—¶é—´çš„90ï¼…ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨Android På’Œä½œä¸º[Jetpack](http://d.android.com/jetpack)çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªæ–°çš„APIï¼š[PrecomputedText](https://developer.android.com/reference/android/text/PrecomputedText)ã€‚åœ¨API 14ä¸­ä½¿ç”¨[PrecomputedTextCompat](https://developer.android.com/reference/androidx/core/text/PrecomputedTextCompat)

PrecomputedTextä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿé¢„å…ˆæ‰§è¡Œæ–‡æœ¬å¸ƒå±€ä¸­æœ€è€—æ—¶çš„éƒ¨åˆ†ï¼Œå³ä½¿åœ¨åå°çº¿ç¨‹ä¸Šï¼Œä¹Ÿå¯ä»¥ç¼“å­˜å¸ƒå±€ç»“æœå¹¶è¿”å›æœ‰ä»·å€¼çš„æµ‹é‡æ•°æ®ã€‚ç„¶åå¯ä»¥è®¾ç½®PrecomputedText.createï¼ˆCharSequenceï¼Œparamsï¼‰çš„åˆ›å»ºTextViewã€‚æœ‰äº†è¿™ä¸ªï¼ŒTextViewåªå®Œæˆäº†å¤§çº¦10ï¼…çš„å·¥ä½œã€‚

![img](../images/2018.7.4.1.png)  
<small>æµ‹é‡å’Œå¸ƒå±€æ–‡æœ¬æ‰€ç”¨æ—¶é—´çš„ç™¾åˆ†æ¯”</small>

```code
// UI thread
val params: PrecomputedText.Params = textView.getTextMetricsParams()
val ref = WeakReference(textView)
executor.execute {
    // background thread
    val text = PrecomputedText.create("Hello", params)
    val textView = ref.get()
    textView?.post {
        // UI thread
        val textViewRef = ref.get()
        textViewRef?.text = text
    }
}
```

## æ”¾å¤§é•œ

å³ä½¿ä½¿ç”¨æ™ºèƒ½æ–‡æœ¬é€‰æ‹©ç­‰åŠŸèƒ½ï¼Œç²¾ç¡®é€‰æ‹©æ–‡æœ¬ä¹Ÿå…·æœ‰æŒ‘æˆ˜æ€§ã€‚Android På¼•å…¥äº†æ–‡æœ¬æ”¾å¤§é•œï¼Œä»¥æ”¹å–„ç”¨æˆ·é€‰æ‹©æ–‡æœ¬çš„ä½“éªŒã€‚æ”¾å¤§é•œé€šè¿‡å¯ä»¥åœ¨æ–‡æœ¬ä¸Šæ‹–åŠ¨çš„çª—æ ¼æŸ¥çœ‹æ”¾å¤§æ–‡æœ¬ï¼Œå¸®åŠ©ç”¨æˆ·ç²¾ç¡®å®šä½å…‰æ ‡æˆ–æ–‡æœ¬é€‰æ‹©æ‰‹æŸ„ã€‚

![img](../images/2018.7.4.2.gif)  
<small>Android Pä¸­çš„æ”¾å¤§æ–‡å­—</small>

æˆ‘ä»¬å¸Œæœ›ç”¨æˆ·åœ¨æ‰€æœ‰åº”ç”¨ç¨‹åºä¸­æ‹¥æœ‰ç›¸åŒçš„ä½“éªŒï¼Œæ— è®ºæ˜¯åœ¨è‡ªå®šä¹‰å°éƒ¨ä»¶ä¸­è¿˜æ˜¯åœ¨è‡ªå®šä¹‰æ–‡æœ¬å‘ˆç°æœŸé—´ï¼Œå› æ­¤æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª[Magnifier](https://developer.android.com/reference/android/widget/Magnifier)å°éƒ¨ä»¶ï¼Œå¯ä»¥åº”ç”¨äºé™„åŠ åˆ°çª—å£çš„ä»»ä½•è§†å›¾ã€‚æ”¾å¤§é•œå°éƒ¨ä»¶å¯ä»¥æä¾›ä»»ä½•è§†å›¾æˆ–æ›²é¢çš„æ”¾å¤§ç‰ˆæœ¬ï¼Œè€Œä¸ä»…ä»…æ˜¯æ–‡æœ¬ã€‚

æ”¾å¤§é•œæœ‰3ç§ä¸»è¦æ–¹æ³•ï¼šæ˜¾ç¤ºï¼Œæ›´æ–°å’Œæ¶ˆé™¤ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨ä¸ºè‡ªå®šä¹‰è§†å›¾å®ç°onTouchEventå¤„ç†æ—¶è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚è¿™å°†å¯¼è‡´æ”¾å¤§é•œæ²¿ç€å±å¹•è·Ÿéšç”¨æˆ·çš„æ‰‹æŒ‡ã€‚

```code
fun onTouchEvent(event: MotionEvent): Boolean {
    when (event.actionMasked) {
        MotionEvent.ACTION_DOWN -> 
              magnifier.show(event.x, event.y)
        MotionEvent.ACTION_MOVE -> 
             magnifier.show(event.x, event.y)
        MotionEvent.ACTION_UP -> 
             magnifier.dismiss()
    }
}
```

## Smart Linkify

[Linkify](https://developer.android.com/reference/android/text/util/Linkify)ç±»è‡ªAPI 1å­˜åœ¨ä»¥æ¥å…è®¸ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ·»åŠ æ–‡æœ¬é“¾æ¥ã€‚æœ€é‡è¦çš„æ˜¯ï¼ŒæŸ¥æ‰¾ç‰©ç†åœ°å€ä¼šæ—‹è½¬WebViewå®ä¾‹ä»¥ç”Ÿæˆç»“æœï¼Œè¿™ä¼šé™ä½è¯·æ±‚é“¾æ¥çš„åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ä¸ºäº†ä½¿é“¾æ¥è§£ææ›´å‡†ç¡®ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå›½é™…åŒ–æ–‡æœ¬ï¼Œå¹¶å‡è½»WebViewå¯¼è‡´çš„æ€§èƒ½ä¸‹é™ï¼Œæˆ‘ä»¬åˆ›å»ºäº†Smart Linkifyã€‚å¯ä»¥ä½¿ç”¨[TextClassifier](https://developer.android.com/reference/android/view/textclassifier/TextClassifier)API è®¿é—®Smart Linkify ã€‚

Smart Linkifyä½¿ç”¨æœºå™¨å­¦ä¹ ç®—æ³•å’Œæ¨¡å‹æ¥è¯†åˆ«æ–‡æœ¬ä¸­çš„å®ä½“ã€‚è¿™æé«˜äº†æ‰€è¯†åˆ«å®ä½“çš„å¯é æ€§ã€‚Smart Linkifyå¯ä»¥æ ¹æ®å®ä½“ç±»å‹å»ºè®®ç”¨æˆ·å¯ä»¥æ‰§è¡Œçš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œå¦‚æœSmart Linkifyè¯†åˆ«å‡ºç”µè¯å·ç ï¼Œåˆ™APIä¼šå»ºè®®è¯¸å¦‚å‘é€çŸ­ä¿¡ï¼Œæ‹¨æ‰“ç”µè¯æˆ–æ·»åŠ è”ç³»äººç­‰æ“ä½œã€‚

![img](../images/2018.7.4.3.gif)  
<small>Android Pä¸­çš„Smart Linkify</small>

è¦æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œè¯·å°†ç”Ÿæˆå’Œåº”ç”¨é“¾æ¥çš„å·¥ä½œç§»è‡³åå°çº¿ç¨‹ã€‚

```code
// UI thread
val text: Spannable = ...
val request = TextLinks.Request.Builder(text)
val ref = WeakReference(textView)
executor.execute {
    // background thread
    TextClassifier.generateLinks(request).apply(text)
    val textView = ref.get()
    textView?.post {
        // UI thread
        val textViewRef = ref.get()
        textViewRef?.text = text
    }
}
```

## è¡Œé«˜å’ŒåŸºçº¿æ–‡æœ¬å¯¹é½

è®¾è®¡äººå‘˜æœ‰æ—¶ä¼šä¸ºå®Œå…¨ä¸ç°æœ‰TextViewå±æ€§ä¸åŒ¹é…çš„å¼€å‘è€…æä¾›å¸ƒå±€è§„èŒƒã€‚åœ¨Android På’ŒJetpackä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸‰ä¸ªå±æ€§åŠå…¶ç›¸åº”çš„åŠŸèƒ½ï¼Œä»¥å¸®åŠ©å¼¥åˆè®¾è®¡äººå‘˜å’Œå¼€å‘è€…å·¥ä½œæ–¹å¼ä¹‹é—´çš„å·®è·ã€‚

### è®¾ç½®è¡Œé«˜

åœ¨Android Pä¹‹å‰ï¼Œå¯ä»¥ä½¿ç”¨<i>lineSpacingExtra
</i>å’Œ<i>lineSpacingMultiplier</i>å±æ€§æ§åˆ¶è¡Œä¹‹é—´çš„é—´è·ã€‚ä½†æ˜¯ï¼Œè®¾è®¡äººå‘˜é€šå¸¸ä¼šå°†è¿™äº›å€¼ä½œä¸ºç®€å•çš„çº¿é«˜æä¾›ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œåœ¨Android Pä¸Šï¼Œæˆ‘ä»¬æ·»åŠ äº†[lineHeight](https://developer.android.com/reference/android/widget/TextView.html#attr_android:lineHeight)å±æ€§æ¥è®¾ç½®æ–‡æœ¬çš„è¡Œé«˜ï¼šå³è¡Œçš„é¡¶éƒ¨å’Œåº•éƒ¨ä¹‹é—´çš„è·ç¦»ï¼ˆæˆ–åç»­åŸºçº¿ä¹‹é—´çš„è·ç¦»ï¼‰ã€‚åœ¨å¼•æ“ä¸‹ï¼Œæ­¤å±æ€§å®é™…ä¸Šä½¿ç”¨å’Œä¿®æ”¹ç°æœ‰<i>lineSpacingExtra</i>å’Œ<i>lineSpacingMultiplier</i>å±æ€§ã€‚

![img](../images/2018.7.4.4.png)  
<small>è¡Œé«˜å’Œå­—ä½“å¤§å°çš„å¤§å°</small>

```code
<TextView
    android:layout_height="wrap_content"
    android:layout_width="match_parent"
    android:text="Lorem ipsum dolor sit amet"
    app:lineHeight="50sp"/>

// or in code
TextView.setLineHeight(@Px int)
```    

### è®¾ç½®åŸºçº¿æ–‡æœ¬å¯¹é½æ–¹å¼

ä¸ºäº†æ§åˆ¶ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªåŸºçº¿ä¸è§†å›¾è¾¹ç•Œçš„è·ç¦»ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªæ–°å±æ€§ï¼š[firstBaselineToTopHeight](https://developer.android.com/reference/android/widget/TextView.html#attr_android:firstBaselineToTopHeight)å’Œ[lastBaselineToBottomHeight](https://developer.android.com/reference/android/widget/TextView.html#attr_android:lastBaselineToBottomHeight)ã€‚

<i>firstBaselineToTopHeight</i>ï¼šè®¾ç½®TextViewçš„ä¸Šè¾¹ç•Œä¸TextViewç¬¬ä¸€è¡Œçš„åŸºçº¿ä¹‹é—´çš„è·ç¦»ã€‚åœ¨å¼•æ“ä¸‹ï¼Œæ­¤å±æ€§æ›´æ–°é¡¶éƒ¨å¡«å……ã€‚

<i>lastBaselineToBottomHeight</i>ï¼šè®¾ç½®TextViewçš„åº•éƒ¨è¾¹ç•Œä¸TextViewçš„æœ€åä¸€è¡Œçš„åŸºçº¿ä¹‹é—´çš„è·ç¦»ã€‚åœ¨å¼•æ“ä¸‹ï¼Œæ­¤å±æ€§å®é™…ä¸Šæ›´æ–°äº†åº•éƒ¨å¡«å……ã€‚

![img](../images/2018.7.4.5.png)  
ç¬¬ä¸€ä¸ªåŸºçº¿åˆ°é¡¶éƒ¨å’Œæœ€åä¸€ä¸ªåŸºçº¿åˆ°åº•éƒ¨ä¹‹é—´çš„è·ç¦»

```code
<TextView
    android:layout_height="wrap_content"
    android:layout_width="match_parent"
    android:text="Lorem ipsum dolor sit amet"
    app:firstBaselineToTopHeight="28sp"
    app:lastBaselineToBottomHeight="20sp"/>

// or in code
TextView.setFirstBaselineToTopHeight(@Px int)
TextView.setLastBaselineToBottomHeight(@Px int)
```

æ–‡æœ¬åœ¨ç»å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­æ‰®æ¼”ç€é‡è¦è§’è‰² - å®ƒæ˜¯åº”ç”¨ç¨‹åºè®¾è®¡è¯­è¨€çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æ–‡æœ¬ç”±ç”¨æˆ·ä½¿ç”¨ï¼Œç”šè‡³å‘ˆç°emojiè¡¨æƒ…ç¬¦å·ğŸ˜ã€‚æˆ‘ä»¬å°†ç»§ç»­ç ”å‘æ–‡æœ¬ï¼Œæ”¹å–„åº”ç”¨ç”¨æˆ·å’Œå¼€å‘è€…çš„ä½“éªŒã€‚

è¦äº†è§£æœ‰å…³ä½¿ç”¨æ–‡æœ¬APIçš„æ›´å¤šä¿¡æ¯ä»¥åŠAndroid Pä¸­æœ‰å…³æ–‡æœ¬çš„æ–°å†…å®¹ï¼Œè¯·æŸ¥çœ‹Google I / O 2018å…³äºâ€œå¸¦æ–‡å­—çš„æœ€ä½³å®è·µâ€çš„æ¼”è®²ï¼š

[è§†é¢‘ä»‹ç»](https://youtu.be/x-FcOX6ErdI)